name: Winlator Rootfs Build (use BCC)

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      inputGstVersion:
        description: "输入gstreamer版本："
        required: true
        default: "1.27.2"
      inputXzVersion:
        description: "输入xz版本："
        required: true
        default: "v5.8.1"
      inputVorbisVersion:
        description: "输入vorbis版本："
        required: true
        default: "v1.3.7"
      inputFlacVersion:
        description: "输入flac版本："
        required: true
        default: "1.5.0"
      inputXkbcommonVersion:
        description: "输入xkbcommon的版本："
        required: true
        default: "xkbcommon-1.13.0"
      inputMangohudVersion:
        description: "请输入MangoHud版本："
        required: true
        default: "cmod"
      inputCustomTag:
        description: "输入自定义Tag名称："
        required: true
        default: "beta11-g2.39"

env:
  gstVer: ${{ github.event.inputs.inputGstVersion }}
  xzVer: ${{ github.event.inputs.inputXzVersion }}
  xkbcommonVer: ${{ github.event.inputs.inputXkbcommonVersion }}
  mangohudVer: ${{ github.event.inputs.inputMangohudVersion }}
  customTag: ${{ github.event.inputs.inputCustomTag }}
  vorbisVer: ${{ github.event.inputs.inputVorbisVersion }}
  flacVer: ${{ github.event.inputs.inputFlacVersion }}

jobs:
  BCC:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: BCC
        run: |
          echo "gstreamer ${gstVer}"
          curl -L -O "https://github.com/Waim908/BCC/releases/download/wlt-bcc-latest/wlt-bcc.tar.xz"
          sudo tar xf wlt-bcc.tar.xz -C /tmp
          cd /tmp
          git clone https://github.com/Waim908/rootfs-custom-winlator.git
          sudo cp rootfs-custom-winlator/build-rootfs.sh /tmp/archlinux/bin
          mv rootfs-custom-winlator/data.tar.xz /tmp/archlinux/tmp
          mv rootfs-custom-winlator/tzdata-2025b-1-aarch64.pkg.tar.xz /tmp/archlinux/tmp
          mv rootfs-custom-winlator/patches /tmp/archlinux/tmp
          mv rootfs-custom-winlator/mangohud.tar.xz /tmp/archlinux/tmp
          mv rootfs-custom-winlator/fonts /tmp/archlinux/tmp
          mv rootfs-custom-winlator/extra /tmp/archlinux/tmp
          mv rootfs-custom-winlator/lame-3.100 /tmp/archlinux/tmp
          sudo chmod +x /tmp/archlinux/bin/build-rootfs.sh
          # sudo chmod 777 /tmp/archlinux/tmp
          # cd /tmp/archlinux/tmp
          # git clone -b ${gstVer} https://gitlab.freedesktop.org/gstreamer/gstreamer.git gstreamer-src
          # cd /tmp
          cat > /tmp/archlinux/tmp/init.sh << EOF
          export gstVer=$gstVer
          export xzVer=$xzVer
          export xkbcommonVer=$xkbcommonVer
          export mangohudVer=$mangohudVer
          export customTag=$customTag
          export flacVer=$flacVer
          export vorbisVer=$vorbisVer
          EOF
          # echo "export gstVer=$gstVer" > /tmp/archlinux/tmp/init.sh
          # echo "export xzVer=$xzVer" >> /tmp/archlinux/tmp/init.sh
          # echo "export vorbisVer=$vorbisVer" >> /tmp/archlinux/tmp/init.sh
          sudo mount --bind /proc archlinux/proc
          sudo mount --bind /sys archlinux/sys
          sudo mount --bind /dev archlinux/dev
          if ! sudo chroot /tmp/archlinux /bin/build-rootfs.sh; then
            echo "失败"
            exit 1
          fi
          sudo umount -l archlinux/dev
          sudo umount -l archlinux/sys
          sudo umount -l archlinux/proc

      # - name: Package
      #   run: |
      #     cd /tmp/archlinux/data/data/com.termux/files/usr
      #     tar -I "xz -T$(nproc)" -cvf /tmp/gstreamer-${gstVer}.tar.xz glibc/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: rootfs-${{ github.event.inputs.inputCustomTag }}
          draft: false
          prerelease: false
          tag_name: rootfs-${{ github.event.inputs.inputCustomTag }}
          body: |
              xz=> ${{ github.event.inputs.inputXzVersion }}
              libmp3lame=> 3.100
              libFLAC=> ${{ github.event.inputs.inputFlacVersion }}
              libvorbis=> ${{ github.event.inputs.inputVorbisVersion }}
              gstreamer=> ${{ github.event.inputs.inputGstVersion }}
              xkbcommon=> ${{ github.event.inputs.inputXkbcommonVersion }}
              MangoHud=> ${{ github.event.inputs.inputMangohudVersion }}
              customTag=> ${{ github.event.inputs.inputCustomTag }}

          files: |
            /tmp/archlinux/tmp/output/output-lite.tar.xz
            /tmp/archlinux/tmp/output/output-full.tar.xz
            /tmp/archlinux/tmp/output/rootfs.tzst
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}